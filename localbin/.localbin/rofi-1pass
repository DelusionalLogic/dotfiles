#!/bin/bash
set -eo pipefail

export OP_FORMAT=json

: "${PINENTRY_PROGRAM:=pinentry-gnome3}"

debug() {
    echo "$@" > /dev/stderr
}

create_session() {
	if [[ -f "$HOME/.config/passrofil/passwd" ]]; then
		masterpass=$(gpg --decrypt "$HOME/.config/passrofil/passwd" 2>/dev/null)
		if [[ $? -eq 0 ]] ; then
			echo "$masterpass" | op signin > .config/op/session
			return 0
		fi
	fi

    if command -v $PINENTRY_PROGRAM > /dev/null; then
        $PINENTRY_PROGRAM << EOS | grep -oP 'D \K.*' | op signin > ~/.config/op/session
SETDESC Enter your 1password master password:
SETPROMPT Master Password:
GETPIN
EOS
    fi
}

login() {
    source ~/.config/op/session
	# Check if the session is valid
    if ! op vault list > /dev/null; then
		# Create a new one if it isn't
		create_session
	fi
    source ~/.config/op/session
}

print-account-list() {
    set +e
    op item list | jq -r '.[] | " - \(.title) [\(.id)]"'
    LOGGED_IN=${PIPESTATUS[0]}
    set -e

    if [ $LOGGED_IN -eq 127 ]; then
        echo "1password CLI tool 'op' not found"
        exit 2
    fi

    if [ ! $LOGGED_IN -eq 0 ]; then
        echo "Listing failed"
        exit 1
    fi
}

open-account-url() {
    local url=$(op item get "$1" | jq -r '.urls[0].href')
    if [[ -n $url ]]; then
        xdg-open "$url" >/dev/null 2>/dev/null
    else
        exit 2
    fi
}

is-actual-url() {
    local url="$1"
    if [[ -n $url && "$url" != " " && "$url" != "http://" && "$url" != "https://" ]]; then
        return 0
    else
        return 1
    fi
}

show-account-options() {
    local id="$1"
    local entry=$(op item get "$id")

    echo ">> Copy password [$id]"
    echo ">> Copy username [$id]"

    if [[ -n $(echo $entry | jq -r '.fields[] | select(.type == "OTP")') ]]; then
        echo ">> Copy OTP [$id]"
    fi

    url=$(echo $entry | jq -r '.urls[0].href')
    if is-actual-url "$url"; then
        echo ">> Open $url [$id]"
        echo ">> Copy URL [$id]"
    fi

    echo ">> Copy ID [$id]"
}

id-in-selection() {
    echo "$1" | grep -oE '\[[a-z0-9]+\]$' | tr -d '[]'
}

clipboard() {
    xclip -selection c >/dev/null 2>/dev/null
}

login

if [[ -n "$1" ]]; then
    selected="$1"
    id="$(id-in-selection "$selected")"

    if [[ -n $id ]]; then
        case "$selected" in
            '>> Copy password'*)
                op item get "$id" | jq -j '.fields[] | select(.purpose == "PASSWORD") | .value' | clipboard
                ;;
            '>> Copy username'*)
                op item get "$id" | jq -j '.fields[] | select(.purpose == "USERNAME") | .value' | clipboard
                ;;
            '>> Copy OTP'*)
                op item get "$id" | jq -j '.fields[] | select(.type == "OTP") | .totp' | clipboard
                ;;
            '>> Copy URL'*)
                op item get "$id" | jq -j '.urls[0].href' | clipboard
                ;;
            '>> Copy ID'*)
                op item get "$id" | jq -j '.id' | clipboard
                ;;
            '>> Open'*)
                open-account-url "$id"
                ;;
            *)
                show-account-options "$id"
                ;;
        esac
    else
        echo "Could not detect the entry ID of \"${selected}\""
        exit 1
    fi
else
    print-account-list
fi
